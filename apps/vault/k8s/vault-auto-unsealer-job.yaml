---
# Secret to store unseal keys (you'll populate this after vault init)
apiVersion: v1
kind: Secret
metadata:
  name: vault-unseal-keys
  namespace: vault
type: Opaque
stringData:
  # Add your unseal keys here after initialization
  # key1: "your-first-unseal-key"
  # key2: "your-second-unseal-key"
  # key3: "your-third-unseal-key"
---
# ServiceAccount for the unsealer job
apiVersion: v1
kind: ServiceAccount
metadata:
  name: vault-unsealer
  namespace: vault
---
# Role to allow reading pods
apiVersion: rbac.authorization.k8s.io/v1
kind: Role
metadata:
  name: vault-unsealer
  namespace: vault
rules:
- apiGroups: [ "" ]
  resources: [ "pods" ]
  verbs: [ "get", "list" ]
- apiGroups: [ "" ]
  resources: [ "pods/exec" ]
  verbs: [ "create" ]
---
# RoleBinding
apiVersion: rbac.authorization.k8s.io/v1
kind: RoleBinding
metadata:
  name: vault-unsealer
  namespace: vault
roleRef:
  apiGroup: rbac.authorization.k8s.io
  kind: Role
  name: vault-unsealer
subjects:
- kind: ServiceAccount
  name: vault-unsealer
  namespace: vault
---
# CronJob that runs every 2 minutes to check and unseal vault pods
apiVersion: batch/v1
kind: CronJob
metadata:
  name: vault-auto-unsealer
  namespace: vault
spec:
  schedule: "*/2 * * * *" # Every 2 minutes
  successfulJobsHistoryLimit: 1
  failedJobsHistoryLimit: 1
  concurrencyPolicy: Forbid
  jobTemplate:
    spec:
      template:
        spec:
          serviceAccountName: vault-unsealer
          restartPolicy: OnFailure
          containers:
          - name: unsealer
            image: alpine/kubectl:1.34.2
            command:
            - /bin/sh
            - -c
            - |
              #!/bin/sh
              set -e

              echo "Checking Vault pods for sealed status..."

              # Get all vault pods
              for pod in vault-0 vault-1 vault-2; do
                echo "Checking $pod..."
                
                # Check if pod exists and is running
                if ! kubectl get pod $pod -n vault >/dev/null 2>&1; then
                  echo "Pod $pod does not exist, skipping..."
                  continue
                fi
                
                # Check vault status (combine stdout and stderr since sealed vault outputs to stderr)
                STATUS=$(kubectl exec $pod -n vault -- vault status -format=json 2>&1 || true)
                SEALED=$(echo "$STATUS" | grep -o '"sealed":[^,}]*' | cut -d':' -f2 | tr -d ' ')
                INITIALIZED=$(echo "$STATUS" | grep -o '"initialized":[^,}]*' | cut -d':' -f2 | tr -d ' ')
                
                if [ "$INITIALIZED" = "true" ] && [ "$SEALED" = "true" ]; then
                  echo "$pod is sealed, attempting to unseal..."
                  
                  # Read unseal keys from secret
                  KEY1=$(cat /vault/unseal-keys/key1 2>/dev/null || echo "")
                  KEY2=$(cat /vault/unseal-keys/key2 2>/dev/null || echo "")
                  KEY3=$(cat /vault/unseal-keys/key3 2>/dev/null || echo "")
                  
                  if [ -z "$KEY1" ]; then
                    echo "ERROR: No unseal keys found in secret! Please populate vault-unseal-keys secret."
                    continue
                  fi
                  
                  # Unseal with available keys
                  [ -n "$KEY1" ] && kubectl exec $pod -n vault -- vault operator unseal "$KEY1" || true
                  [ -n "$KEY2" ] && kubectl exec $pod -n vault -- vault operator unseal "$KEY2" || true
                  [ -n "$KEY3" ] && kubectl exec $pod -n vault -- vault operator unseal "$KEY3" || true
                  
                  echo "$pod unseal attempted"
                elif [ "$INITIALIZED" = "false" ]; then
                  echo "$pod is not initialized yet"
                else
                  echo "$pod is already unsealed"
                fi
              done

              echo "Unseal check complete"
            volumeMounts:
            - name: unseal-keys
              mountPath: /vault/unseal-keys
              readOnly: true
            env:
            - name: VAULT_SKIP_VERIFY
              value: "true"
          volumes:
          - name: unseal-keys
            secret:
              secretName: vault-unseal-keys
              optional: true
